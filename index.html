<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>抽签开始打工！</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <style type="text/tailwindcss">
        @layer utilities {
            .animate-number-zoom {
                animation: numberZoom 5s ease-in-out infinite;
            }
            @keyframes numberZoom {
                0% { 
                    transform: scale(1) translate(5vw, 5vh);
                    opacity: 0.7;
                }
                25% { 
                    transform: scale(1.3) translate(30vw, 15vh); 
                    opacity: 0.9;
                }
                50% { 
                    transform: scale(1.5) translate(-25vw, -10vh); 
                    opacity: 0.8;
                }
                75% { 
                    transform: scale(1.4) translate(-20vw, 15vh); 
                    opacity: 0.95;
                }
                100% { 
                    transform: scale(1) translate(0vw, 0vh);
                    opacity: 0.7;
                }
            }
            .btn-pulse {
                animation: btnPulse 2s infinite;
            }
            @keyframes btnPulse {
                0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4); }
                70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
                100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
            }
            .animate-letter-roll {
                animation: letterRoll 0.5s ease-out;
            }
            @keyframes letterRoll {
                0% { transform: scale(0.5) rotate(-10deg); opacity: 0; }
                70% { transform: scale(1.2) rotate(5deg); opacity: 0.8; }
                100% { transform: scale(1) rotate(0); opacity: 1; }
            }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4CAF50',
                        secondary: '#ff5722',
                    },
                    fontFamily: {
                        sans: ['Microsoft YaHei', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<body class="min-h-screen">
    <div id="networkError" class="fixed inset-0 bg-gray-900/95 z-50 flex items-center justify-center hidden">
        <div class="text-center p-8 bg-white rounded-xl shadow-2xl max-w-md">
            <h2 class="text-3xl font-bold text-red-600 mb-4">无法连接服务器</h2>
            <p class="text-gray-700 mb-6">请检查您的网络连接后重试</p>
            <p class="text-gray-500 text-sm">ERR_CONNECTION_REFUSED</p>
        </div>
    </div>

    <div class="dynamic-layer fixed inset-0 z-10 pointer-events-none opacity-20">
        <div class="dynamic-item absolute inset-0 bg-[url('https://p2.ssl.qhimgs1.com/t049c545a18debeb67f.png')] bg-cover bg-center"></div>
    </div>
    <div class="dynamic-layer fixed inset-0 z-20 pointer-events-none">
        <div class="absolute inset-0 flex items-center justify-center overflow-hidden z-30">
            <div class="number-display text-[clamp(12rem,24vw,36rem)] font-bold 
                       animate-number-zoom opacity-50
                       bg-gradient-to-r from-yellow-400 to-orange-500 
                       text-transparent bg-clip-text
                       drop-shadow-lg hidden
                       max-w-[80vw] max-h-[80vh]">
                <span id="rollingNumber" class="inline-block">0</span>
            </div>
        </div>
    </div>
    
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <h1 class="text-[clamp(2rem,5vw,3rem)] font-bold text-primary mb-6 tracking-tight text-center">抽签开始打工！</h1>
        <div class="flex flex-col lg:flex-row gap-8">
            <div class="lg:w-1/4 order-1">
                <div class="bg-transparent backdrop-filter backdrop-blur-sm rounded-xl shadow-lg h-full p-6 sticky top-8">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2 flex items-center">
                        <i class="fa fa-history mr-2 text-primary"></i> 抽签记录
                    </h2>
                    <div id="records" class="space-y-3 max-h-[calc(100vh-300px)] overflow-y-auto"></div>
                </div>
            </div>
            
            <div class="lg:w-1/2 order-2">
                <div class="bg-transparent backdrop-filter backdrop-blur-sm rounded-xl shadow-lg p-6 mb-8 transform transition-all duration-300 hover:shadow-xl">
                    <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
                        <div class="md:col-span-1">
                            <label class="block text-gray-700 font-medium mb-2">
                                抽签人数:
                                <input type="number" id="peopleCount" min="1" value="" placeholder="请输入人数"
                                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all hover:btn-pulse">
                            </label>
                        </div>
                        <div class="md:col-span-1">
                            <label class="block text-gray-700 font-medium mb-2">
                                抽签次数:
                                <input type="number" id="drawCount" min="1" value="" placeholder="请输入次数"
                                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all hover:btn-pulse">
                            </label>
                        </div>
                        <div class="md:col-span-1">
                            <label class="block text-gray-700 font-medium mb-2">
                                滚动时间(秒):
                                <input type="number" id="rollTime" min="0.5" step="0.5" value="2" placeholder="滚动时间"
                                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all hover:btn-pulse">
                            </label>
                        </div>
                        <div class="md:col-span-1">
                            <label class="block text-gray-700 font-medium mb-2">
                                字母抽签范围(A-Z):
                                <input type="text" id="letterRange" placeholder="例如: A B C D E"
                                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-secondary focus:border-secondary transition-all uppercase hover:btn-pulse">
                            </label>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <label class="flex items-center space-x-2 text-gray-700">
                            <input type="checkbox" id="letterSwitch" class="form-checkbox h-5 w-5 text-primary">
                            <span>启用字母抽签功能</span>
                        </label>
                    </div>
                </div>
                
                <div class="mt-4 flex justify-center w-full flex-col items-center">
                    <button id="drawBtn" 
                        class="w-full px-8 py-6 md:px-10 md:py-8 bg-primary text-white rounded-lg shadow-lg transform transition-all duration-300 hover:bg-primary/90 active:scale-120 disabled:opacity-50 disabled:cursor-not-allowed text-3xl md:text-4xl"
                        disabled
                        title="点击按钮或按回车键开始抽签">
                        开始抽签
                    </button>
                    <p class="text-xs md:text-sm text-gray-500 mt-2 text-center max-w-xs">
                        提示：回车键或点击按钮均可启动抽签
                    </p>
                    <div id="currentResult" 
                        class="mt-4 text-2xl md:text-3xl font-bold text-primary text-center hidden 
                              opacity-0 transition-all duration-500">
                    </div>
                </div>
                
                <div id="result"
                    class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2
                          text-[clamp(3rem,15vw,10rem)] font-bold text-primary 
                          animate-letter-roll hidden z-30">
                </div>
            </div>
         
            <div class="lg:w-1/4 order-3">
                <div class="bg-transparent backdrop-filter backdrop-blur-sm rounded-xl shadow-lg h-full p-6 sticky top-8">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2 flex items-center">
                        <i class="fa fa-list mr-2 text-secondary"></i> 字母抽签记录
                    </h2>
                    <div id="letterRecords" class="space-y-4 max-h-[calc(100vh-300px)] overflow-y-auto">
                    </div>
                </div>
            </div>
        </div>
        
        <div id="endMessage"
            class="fixed inset-0 bg-white/90 flex items-center justify-center z-50 transform transition-all duration-500 opacity-0 pointer-events-none">
            <div class="text-center">
                <div class="text-[clamp(4rem,10vw,10rem)] font-bold text-secondary mb-4">娱乐结束</div>
                <div class="text-[clamp(3rem,7vw,6rem)] text-gray-700">做回打工人的一天开始了！</div>
                <button id="restartBtn"
                    class="mt-8 px-8 py-4 bg-primary text-white rounded-lg shadow-lg transform transition-all duration-300 hover:bg-primary/90 active:scale-95 text-xl md:text-3xl">
                    重新开始
                </button>
            </div>
        </div>
    </div>
    
    <script>
        const STORAGE_KEY = 'drawUsageCount';
        const DATE_KEY = 'lastDrawDate';
        const END_PAGE_MARKER = 'endPageActive';
        const MAX_USAGE_PER_DAY = 3;
        
        const MUST_DRAW_SETTINGS = [
            { round: 1, number: 4 },
            { round: 2, number: 7 },
            { round: 3, number: 3 }, 
            { round: 4, number: 9 },
            { round: 5, number: 1 },
            { round: 6, number: 10 }, 
            { round: 7, number: 2 }, 
            { round: 8, number: 6 },
            { round: 9, number: 5 }, 
            { round: 10, number: 8 }  
        ];
        
        function getCurrentDate() {
            const date = new Date();
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }
        
        function loadAccessState() {
            const currentDate = getCurrentDate();
            const savedDate = localStorage.getItem(DATE_KEY);
            let savedCount = localStorage.getItem(STORAGE_KEY);
            
            if (savedDate !== currentDate) {
                localStorage.setItem(STORAGE_KEY, '0');
                localStorage.setItem(DATE_KEY, currentDate);
                savedCount = '0';
            }
            
            const wasOnEndPage = localStorage.getItem(END_PAGE_MARKER) === 'true';
            if (wasOnEndPage) {
                const currentCount = parseInt(savedCount || '0');
                const newCount = currentCount + 1;
                localStorage.setItem(STORAGE_KEY, newCount.toString());
                savedCount = newCount.toString();
                localStorage.removeItem(END_PAGE_MARKER);
            }
            
            return parseInt(savedCount || '0');
        }
        
        function incrementUsageCount() {
            const currentDate = getCurrentDate();
            const savedCount = localStorage.getItem(STORAGE_KEY) || '0';
            const newCount = parseInt(savedCount) + 1;
            
            localStorage.setItem(STORAGE_KEY, newCount.toString());
            localStorage.setItem(DATE_KEY, currentDate);
            
            return newCount;
        }

        const peopleCountInput = document.getElementById('peopleCount');
        const drawCountInput = document.getElementById('drawCount');
        const rollTimeInput = document.getElementById('rollTime');
        const letterRangeInput = document.getElementById('letterRange');
        const letterSwitch = document.getElementById('letterSwitch');
        const drawBtn = document.getElementById('drawBtn');
        const resultDiv = document.getElementById('result');
        const recordsDiv = document.getElementById('records');
        const letterRecordsDiv = document.getElementById('letterRecords');
        const endMessageDiv = document.getElementById('endMessage');
        const restartBtn = document.getElementById('restartBtn');
        const numberDisplay = document.querySelector('.number-display');
        const rollingNumber = document.getElementById('rollingNumber');
        const networkErrorDiv = document.getElementById('networkError');
        const mainContent = document.querySelector('.container');
        
        let remainingPeople = [];
        let currentRound = 1;
        let totalRounds = 1;
        let isDrawing = false;
        let rollInterval;
        let rollStartTime;
        let rollDuration;
        let drawnLetters = [];
        let hasReachedEnd = false;
        let usageCount = 0;
        let isPageLoaded = false;

        function checkAccess() {
            if (usageCount >= MAX_USAGE_PER_DAY) {
                networkErrorDiv.classList.remove('hidden');
                mainContent.style.display = 'none';
                document.querySelectorAll('.dynamic-layer').forEach(layer => layer.style.display = 'none');
                return false;
            } else {
                networkErrorDiv.classList.add('hidden');
                mainContent.style.display = 'block';
                document.querySelectorAll('.dynamic-layer').forEach(layer => layer.style.display = 'block');
                return true;
            }
        }

        function showToast(message) {
            let toast = document.getElementById('toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toast';
                toast.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg z-50 opacity-0 transition-opacity duration-300';
                document.body.appendChild(toast);
            }
            toast.textContent = message;
            toast.style.opacity = '1';
            setTimeout(() => {
                toast.style.opacity = '0';
            }, 3000);
        }

        letterRangeInput.addEventListener('input', function(e) {
            this.value = this.value.toUpperCase();
            let uniqueLetters = [];
            const letters = this.value.split('').filter(c => c >= 'A' && c <= 'Z');
            letters.forEach(c => {
                if (!uniqueLetters.includes(c)) uniqueLetters.push(c);
            });
            this.value = uniqueLetters.join(' ');
        });

        function updateDrawButtonState() {
            const peopleCount = parseInt(peopleCountInput.value);
            const drawCount = parseInt(drawCountInput.value);
            
            if (!isNaN(peopleCount) && peopleCount >= 1 && 
                !isNaN(drawCount) && drawCount >= 1) {
                drawBtn.disabled = false;
                drawBtn.classList.add('btn-pulse');
                return true;
            } else {
                drawBtn.disabled = true;
                drawBtn.classList.remove('btn-pulse');
                return false;
            }
        }

        peopleCountInput.addEventListener('input', updateDrawButtonState);
        drawCountInput.addEventListener('input', updateDrawButtonState);

        function initDraw() {
            if (!updateDrawButtonState()) {
                return;
            }
            
            const peopleCount = parseInt(peopleCountInput.value);
            const rounds = parseInt(drawCountInput.value);
            rollDuration = (parseFloat(rollTimeInput.value) || 2) * 1000;
            
            totalRounds = Math.min(rounds, peopleCount);
            currentRound = 1;
            remainingPeople = Array.from({ length: peopleCount }, (_, i) => i + 1);
            recordsDiv.innerHTML = '';
            letterRecordsDiv.innerHTML = '';
            endMessageDiv.classList.add('opacity-0', 'pointer-events-none');
            drawBtn.textContent = '开始抽签';
            drawnLetters = [];
            hasReachedEnd = false;
            localStorage.removeItem(END_PAGE_MARKER);
            
            showToast(`已准备好 ${peopleCount} 人，共 ${rounds} 次抽签`);
        }

        function performDraw() {
            if (isDrawing) return;
            
            if (currentRound === 1) {
                initDraw();
            }
            
            isDrawing = true;
            drawBtn.disabled = true;
            drawBtn.classList.remove('btn-pulse');
            rollingNumber.textContent = 0;
            numberDisplay.classList.remove('hidden');
            startRolling();
        }

        function startRolling() {
            rollStartTime = Date.now();
            if (rollInterval) clearInterval(rollInterval);
            
            rollInterval = setInterval(() => {
                const elapsed = Date.now() - rollStartTime;
                const progress = Math.min(elapsed / rollDuration, 1);
                
                if (letterSwitch.checked && getValidLetters().length > 0) {
                    const randomLetter = getRandomLetter(getValidLetters());
                    resultDiv.textContent = randomLetter;
                    rollingNumber.textContent = randomLetter;
                } else {
                    const mustDrawConfig = MUST_DRAW_SETTINGS.find(setting => setting.round === currentRound);
                    let randomNumber;
                    
                    if (mustDrawConfig && remainingPeople.includes(mustDrawConfig.number)) {
                        randomNumber = progress > 0.8 ? mustDrawConfig.number : 
                                      remainingPeople[Math.floor(Math.random() * remainingPeople.length)];
                    } else {
                        randomNumber = remainingPeople[Math.floor(Math.random() * remainingPeople.length)];
                    }
                    
                    resultDiv.textContent = randomNumber;
                    rollingNumber.textContent = randomNumber;
                }
                
                if (elapsed >= rollDuration) {
                    clearInterval(rollInterval);
                    finalizeDraw();
                }
            }, 30);
        }

        function getValidLetters() {
            return letterRangeInput.value.split(' ').filter(c => c >= 'A' && c <= 'Z');
        }

        function getRandomLetter(validLetters) {
            return validLetters.length > 0 ? validLetters[Math.floor(Math.random() * validLetters.length)] : '';
        }

        function finalizeDraw() {
            resultDiv.classList.remove('animate-letter-roll');
            if (remainingPeople.length === 0 || currentRound > totalRounds) {
                endDraw();
                return;
            }
            
            const validLetters = getValidLetters();
            if (letterSwitch.checked && validLetters.length > 0) {
                const availableLetters = validLetters.filter(c => !drawnLetters.includes(c));
                
                if (availableLetters.length === 0) {
                    letterSwitch.checked = false;
                    showToast('所有字母已抽取完毕，切换至数字抽签');
                    processNumberDraw();
                } else {
                    const drawnLetter = getRandomLetter(availableLetters);
                    drawnLetters.push(drawnLetter);
                    resultDiv.textContent = drawnLetter;
                    rollingNumber.textContent = drawnLetter;
                    addLetterRecord(drawnLetter);
                    currentRound++;
                }
            } else {
                processNumberDraw();
            }
            
            isDrawing = false;
            if (currentRound <= totalRounds) {
                drawBtn.disabled = false;
                drawBtn.classList.add('btn-pulse');
                drawBtn.textContent = `下一轮抽签 (剩余 ${totalRounds - currentRound + 1} 次)`;
            } else {
                endDraw();
            }
        }

        function processNumberDraw() {
            const mustDrawConfig = MUST_DRAW_SETTINGS.find(setting => setting.round === currentRound);
            let selectedPerson;
            
            if (mustDrawConfig && remainingPeople.includes(mustDrawConfig.number)) {
                selectedPerson = mustDrawConfig.number;
            } else {
                selectedPerson = remainingPeople[Math.floor(Math.random() * remainingPeople.length)];
            }
            
            const selectedIndex = remainingPeople.indexOf(selectedPerson);
            if (selectedIndex > -1) {
                remainingPeople.splice(selectedIndex, 1);
            }
            
            resultDiv.textContent = selectedPerson;
            rollingNumber.textContent = selectedPerson;
            addNumberRecord(selectedPerson);
            currentRound++;
        }

        function addNumberRecord(number) {
            const recordItem = document.createElement('div');
            recordItem.className = 'p-3 bg-gray-50 rounded-lg shadow-sm transform transition-all duration-300 hover:shadow-lg hover:translate-x-1';
            recordItem.innerHTML = `
                <div class="flex justify-between items-center">
                    <div class="font-medium text-primary">第 ${currentRound} 轮</div>
                    <div class="text-xs text-gray-500">${new Date().toLocaleTimeString()}</div>
                </div>
                <div class="text-2xl font-bold text-primary mt-1">${number}号</div>
            `;
            recordsDiv.prepend(recordItem);
        }

        function addLetterRecord(letter) {
            const recordItem = document.createElement('div');
            recordItem.className = 'p-3 bg-gray-50 rounded-lg shadow-sm transform transition-all duration-300 hover:shadow-lg hover:translate-x-1';
            recordItem.innerHTML = `
                <div class="flex justify-between items-center">
                    <div class="font-medium text-secondary">第 ${currentRound} 轮</div>
                    <div class="text-xs text-gray-500">${new Date().toLocaleTimeString()}</div>
                </div>
                <div class="text-2xl font-bold text-secondary mt-1">${letter}</div>
            `;
            letterRecordsDiv.prepend(recordItem);
        }

        function endDraw() {
            numberDisplay.classList.add('hidden');
            setTimeout(() => {
                endMessageDiv.classList.remove('opacity-0', 'pointer-events-none');
                endMessageDiv.classList.add('opacity-100');
                hasReachedEnd = true;
                localStorage.setItem(END_PAGE_MARKER, 'true');
                isDrawing = false;
            }, 500);
        }

        function handleRestart() {
            if (hasReachedEnd) {
                incrementUsageCount();
                localStorage.removeItem(END_PAGE_MARKER);
            }
            window.location.reload();
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !drawBtn.disabled && !isDrawing) {
                performDraw();
            }
        });

        window.addEventListener('load', function() {
            if (!isPageLoaded) {
                isPageLoaded = true;
                usageCount = loadAccessState();
                checkAccess();
                
                if (usageCount < MAX_USAGE_PER_DAY) {
                    drawBtn.addEventListener('click', performDraw);
                    restartBtn.addEventListener('click', handleRestart);
                    updateDrawButtonState();
                }
            }
        });
    </script>
</body>
</html>
